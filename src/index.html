<!--FIX INITIAL VIEW-->

<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" type="text/css" href="metro-interactive-styles.css">
</head>

<body style="min-height:1000px">
<script src="d3.min.js" type="text/javascript"></script>
<script src="state-tracking.js" type="text/javascript"></script>
<script src="map-class.js"></script>
<!--<script src="/home/alec/Projects/metro-map/map-class.js"></script>-->

<div style="position:relative;max-width:950px;width:100%;min-width:320px;min-height:600px;height:100%;margin:auto">
	<div id="metro-index-wrap" class="metro-interactive-wrap"></div>
</div>

<script>
	var el = document.getElementById("metro-index-wrap");
	var MI = MetroInteractive(el);

	var view0 = MI.addView(function(){},null,function(){
		var slide = this.container;
		var header = this.header;
		header.append("p").text("About the Metro Monitor");
		//header.append("p").text("Tracking progress towards an advanced economy that works for all").style({"font-style":"italic","margin-bottom":"0px"});
		//slide.append("hr").style("margin-bottom","20px");
		slide.append("p").style({"font-weight":"bold","color":"#4285f4","margin-bottom":"25px"}).text("[This is space for the opening view. It could be used to convey: 1) What the Monitor is and/or what it measures, 2) Why the Monitor is valuable, and/or 3) A high level overview of the data. It should be snappier than what is here now, and should include at least one graphic. The text here can link to other views in the interactive.]")
		
		slide.append("div").style({"float":"left","width":"56%","padding":"0% 2% 0px 0px"})
			.html("<p>THE METRO MONITOR MEASURES A NEW STANDARD FOR ASSESSING THE SUCCESS OF REGIONAL ECONOMIES</p>")

		slide.append("div").style({"float":"left","width":"56%","padding":"0% 2% 0px 0px"})
			.html("<p>SUCCESS HAS BEEN LIMITED AND VARIED - WE HAVE THE MEASURES</p>")

		slide.append("div").style({"float":"left","width":"56%","padding":"0% 2% 0px 0px"})
			.html("<p>ECONOMIC DEVELOPMENT EFFORTS SHOULD TO CHANGE TO REFLECT THIS</p>")

	});
		

	/////////////////base view

	(function(){
		var colors = ['#d7191c','#fdae61','#ffffbf','#abd9e9','#2c7bb6'];
		var colors = ['#e66101','#fdb863','#f7f7f7','#b2abd2','#5e3c99'];
		var colors = ['#d01c8b','#f1b6da','#f7f7f7','#b8e186','#4dac26'];
		var colors = ['#053769', '#a4c7f2', '#dddddd', '#ffa626', '#ff5e1a'];
		//colors.reverse();

		function r2c(r){
			var q = null;
			var t = "#ffffff";
			var td = "#666666";
			if(r<=20){q=0}
			else if(r<=40){q=1; t=td;}
			else if(r<=60){q=2; t=td;}
			else if(r<=80){q=3;}
			else if(r<=100){q=4}
			else{q=null}
			return {fill:colors[q], text:t};
		}
		
		//hold svg groups -- will be defined in setupBase

		var columns = [{}, {}];

		function drawTable(){
			var VO = this;
			var table = this.storage("table");
			var data = this.viewData("processed");
			var period = this.storage("period");

			var rows = table.selectAll("g.table-row").data(data.universe);
			var rowenter = rows.enter().append("g").style("pointer-events","all").classed("table-row",true);
			//rowenter.append("rect").attr({"x":-15, "y":0, "width":"400px", "height":"60px", "fill":"#ffffff"}).classed("pointer-rect",true)
			rowenter.append("rect").attr({"x":0, "y":0, "width":"100%", "height":"60px", "fill":"#ffffff"}).classed("back-rect",true).style("shape-rendering","crispEdges");
			rowenter.append("text").attr({"x":"1.5%", "y":24}).style("font-size","15px");
			rowenter.append("line").attr({"x1":0, "x2":"100%", "y1":60, "y2":60, "stroke":"#aaaaaa", "stroke-width":"1px"}).style("shape-rendering","crispEdges");

			rows.exit().remove("g");
			rows.attr("transform",function(d,i){
				return "translate(0," + ((i*61)+35) + ")";
			})

			var shiftTimer;
			rows.on("mouseenter",function(d,i){
				clearTimeout(shiftTimer);
				var thiz = d3.select(this);
				//thiz.select("rect.pointer-rect").attr("height","160px");
				thiz.select("rect.back-rect").attr({"height":"160px","fill":"#ffffff"});
				thiz.select("line").attr({"y1":160, "y2":160});
				rows.attr("transform",function(d,j){
					var buffer = j > i ? 100 : 0;
					return "translate(0," + ((j*61)+35+buffer) + ")";
				})

				//hr.attr("transform","translate(0,0)");
			});
			rows.on("mouseleave",function(d,i){
				clearTimeout(shiftTimer);
				var thiz = d3.select(this);
				//thiz.select("rect.pointer-rect").attr("height","60px");
				thiz.select("rect.back-rect").attr({"height":"60px", "fill":"#ffffff"});
				thiz.select("line").attr({"y1":60, "y2":60});
				rows.attr("transform",function(d,j){
					var buffer = 0;
					return "translate(0," + ((j*61)+35+buffer) + ")";
				})

				//hr.attr("transform","translate(0,0)");

			});

			rows.select("text").text(function(d,i){return VO.lookup[d][0].CBSA_Title});

			var swatches = rows.selectAll("g.swatch").data(function(d,i){
				var metro = data.table[d];
				var keyR = period+"R";
				var keyV = period+"V";
				return [{r:metro.gr0[keyR], l:"G: "}, {r:metro.pro0[keyR], l:"P: "}, {r:metro.inc0[keyR], l:"I: "}];
			});
			var eSwatches = swatches.enter().append("g").classed("swatch",true);
			eSwatches.append("rect").attr({"width":"30%","height":20,"y":30}).style("shape-rendering","crispEdges").attr("x",function(d,i){return ((i*33)+1.5)+"%"});
			eSwatches.append("text").attr({"y":45,"text-anchor":"middle"}).style({"font-size":"13px","line-height":"13px"}).attr("x",function(d,i){return ((i*33)+15+1.5)+"%"});

			swatches.exit().remove();
			//swatches.attr("transform", function(d,i){return "translate("+"(15,26)"});

			swatches.select("rect").attr("fill",function(d,i){return (r2c(d.r)).fill});
			swatches.select("text").text(function(d,i){return d.l + d.r}).style("fill",function(d,i){return (r2c(d.r)).text});

			var hr = table.selectAll("g.header-row").data([["Growth (G)", "Prosperity (P)", "Inclusion (I)"]]);
			hr.enter().append("g").classed("header-row",true).append("rect").attr({"height":"40px","width":"100%","fill":"#ffffff"});
			hr.exit().remove();

			var hg = hr.selectAll("g.header-swatch").data(function(d,i){return d});
			var hge = hg.enter().append("g").classed("header-swatch",true);
			hge.append("rect").attr({"width":"30%","height":1,"y":28, "fill":"#aaaaaa", "stroke":"#ffffff", "stroke-width":0}).style("shape-rendering","crispEdges").attr("x",function(d,i){return ((i*33)+1.5)+"%"});
			hge.append("text").attr({"y":22,"text-anchor":"middle"}).style({"font-size":"13px","line-height":"13px","fill":"#666666"}).attr("x",function(d,i){return ((i*33)+15+1.5)+"%"}).text(function(d,i){return d});
			hg.exit().remove();


			this.storage("tableRows",rows);
			this.storage("headerRow",hr);
		}

		//redraw -- setup is just to add html
		function redrawBase(){
			if(!this.viewData("processed")){
				var data = {};
				data.table = {};
				function putInTable(A,propName){
					for(var i=0; i<A.length; i++){
						var prop = A[i].CBSA+"";
						if(!data.table.hasOwnProperty(prop)){data.table[prop] = {}}
						data.table[prop][propName] = A[i];
					}
				}
				putInTable(this.viewData("raw").measures.growth.overall, "gr0");
				putInTable(this.viewData("raw").measures.growth.detailed, "gr1");
				putInTable(this.viewData("raw").measures.prosperity.overall, "pro0");
				putInTable(this.viewData("raw").measures.prosperity.detailed, "pro1");
				putInTable(this.viewData("raw").measures.inclusion.overall, "inc0");
				putInTable(this.viewData("raw").measures.inclusion.detailed, "inc1");

				data.universe = this.viewData("raw").measures.growth.overall.map(function(d,i){return d.CBSA+""});
				this.viewData("processed",data);
			}

			drawTable.call(this);
			//vAlign(this.storage("mapWrap"), this.container);

			//calculate svg height
			var tnode = this.storage("table").node();
			var box = tnode.getBoundingClientRect();
			d3.select(tnode.parentNode).style("height", (Math.round(box.bottom-box.top)+125)+"px");

			var self = this;
			var scrollTimer; //need to fix the header appearance
			function scrollToTop(){
				var rows = self.storage("tableRows");
				var metro = self.getMetro();
				var tableScroll = self.storage("tableOuter");
				var metRow = rows.filter(function(d,i){return d==metro})
				var translate = metRow.attr("transform").replace(/translate\(.*,/g,"").replace(/\D/g,"");
				try{
					var T = translate-35;
					if(T < 0){throw T}
				}
				catch(e){
					var T = 0;
				}

				var headerRow = self.storage("headerRow")
				headerRow.attr("transform","translate(0,"+ T +")");
				tableScroll.node().scrollTop = T; 
				setTimeout(function(){
					tableScroll.on("scroll",function(){
						headerRow.attr("transform","translate(0,0)");
					});					
				},0);

			}
			scrollToTop();
		}

		var alignTimer;
		function vAlign(mapWrap, container){
			//var mBox = mapWrap.getBoundingClientRect();
			var cBox = container.node().getBoundingClientRect();
			var top = cBox.top;
			//clearTimeout(alignTimer);
			//alignTimer = setTimeout(function(){
				if(top >= 0){
					mapWrap.style({"position":"relative","top":"0px","margin-top":"0px"});
				}
				else if(1==2){

				}
				else{
					var off = 0-top;
					mapWrap.style({"position":"fixed","top":"0px","margin-top":"0px"});
				}
			//},300);
		}

		var setupBase = function(){
			this.header.append("p").text("Growth, prosperity, and inclusion in the 100 largest U.S. metro areas");
			//var tableWrap = this.container.append("div").style({"padding":"5px 0px 5px 0px", "border":"1px solid #dddddd", "border-width":"1px 0px 1px 0px"}).classed("two-fifths",true).append("div").style("max-height","600px");
			var headerWrap = this.container.append("div").classed("c-fix",true).style({"margin-bottom":"15px", "border-bottom":"1px solid #aaaaaa", "background-color":"#ffffff", "padding":"15px"});
			var header0 = headerWrap.append("div").classed("three-fifths",true).append("div").style({"padding":"0px 15% 0px 0px", "margin":"0px 0px"});
			header0.append("p").html('<b>Successful economic development should support:</b>');
			header0.append("p").html('&nbsp; &nbsp;<b style="color:#20558a">Growth</b>: Economic expansion').style({"margin":"0px"});
			header0.append("p").html('&nbsp; &nbsp;<b style="color:#20558a">Prosperity</b>: A rising standard of living').style({"margin":"0px"});
			header0.append("p").html('&nbsp; &nbsp;<b style="color:#20558a">Inclusion</b>: Broadly shared prosperity');
			
			header0.append("p").html('<span>Explore the data below to find out which large metro areas have improved most on these metrics over time.</span>').style({"font-style":"italic","line-height":"1.4em","padding-top":"5px"});
			
			
			//CONTROLS
			var header1wrap = headerWrap.append("div").classed("two-fifths",true);
			var header1 = header1wrap.append("div").style({"padding":"5px 10px 10px 15px", "margin":"0px 0px", "background-color":"#ffffff", "border":"1px solid #aaaaaa"});
			header1.append("p").text("Make a selection").style("font-style","italic");

			var timeMenu = header1.append("div").classed("c-fix",true)
			timeMenu.append("p").text("Time period of analysis").style({"margin":"0px","font-size":"11px","text-transform":"uppercase"});
			timeMenu.selectAll("div").data(["One-year", "Five-year", "Ten-year"]).enter().append("div").classed("generic-button",true).append("p").text(function(d,i){return d});

			var catMenu = header1.append("div").classed("c-fix",true).style("margin-top","15px");
			catMenu.append("p").html("Map data / Table sort order").style({"margin":"0px","font-size":"11px","text-transform":"uppercase"});
			catMenu.selectAll("div").data(["Growth", "Prosperity", "Inclusion"]).enter().append("div").classed("generic-button",true).append("p").text(function(d,i){return d});

			var mapWrap = this.container.append("div").classed("three-fifths no-mobile-display",true).append("div").style({"padding":"0px 30px 0px 0px","position":"relative"});
			var smallMapWrap = mapWrap.append("div").classed("c-fix",true)
			smallMapWrap.append("div").style("min-height","50px");
			var smallMaps = smallMapWrap.selectAll("div.small-map").data([1,2,3]).enter().append("div").classed("small-map",true);

			smallMapWrap.selectAll("div").style({"width":"48%","padding-right":"2%","float":"left"});
			smallMaps.each(function(d,i){
				var addNumber = function(){
					console.log(this);
					this.svg.append("circle").attr({"cx":"73%","cy":"20px","r":"10","fill":"#e0e0e0"});
					this.svg.append("text").attr({"x":"73%","y":"24px"}).text(function(d,i){return d}).style({"fill":"#666666","font-size":"13px"}).attr("text-anchor","middle");

				}
				var map = new dotMap(this).drawMap(addNumber).makeResponsive();
			})


			//table
			var rightSide = this.container.append("div").classed("two-fifths",true);

			var tableOuter = rightSide.append("div").style({"clear":"both","border":"1px solid #aaaaaa", "border-width":"1px 0px 1px 0px", "padding":"0px", "max-height":"750px", "overflow-y":"auto"});
			var tableWrap = tableOuter.append("div").style("padding","0px 10px 0px 0px");
			var table = tableWrap.append("svg").style("width","100%").append("g").attr("id","core-svg-table");

			var centerLabels = function(){
				var b = table.node().getBoundingClientRect();
				var w = Math.round(b.right - b.left);
				tableColumnWrap.style("width",w+"px");				
			}
			//window.addEventListener("resize",centerLabels);
			//this.storage("centerLabels",centerLabels);

			var map0 = new dotMap(mapWrap.node()).drawMap().makeResponsive();
			map0.showOverlay();
			setTimeout(function(){map0.hideOverlay()},5000);
			//map0.setData(DAT).drawMap(callback).makeResponsive().showTooltips(textData);

			this.storage("table", table); //store these in the view state
			this.storage("tableOuter", tableOuter);

			this.storage("mapWrap", mapWrap);
			this.storage("period","Five");

			/*window.addEventListener("scroll",function(){
				vAlign(mapWrap, container);
			})*/
		}

		var view1 = MI.addView(redrawBase, "coreIndicators.json", setupBase);
		view1.name("Growth, prosperity, and inclusion");
	})();

	var view2 = MI.addView(function(){
		this.container.append("p").text("Metro Index");
	}, null, function(){this.header.append("p").text("Outcomes by race")})

	//MI.metro = "10140" //can set the default
	
	view0.name("About");
	
	view2.name("Inclusion outcomes by race");

	MI.cap(); //tell the app to try and auto-draw based on hash and defaults
</script>


</body>
</html>
